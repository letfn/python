FROM python:3.8.2-slim-buster

ARG _TINI_VERSION=0.18.0

USER root
RUN apt-get update && apt-get install -y sudo && apt-get upgrade -y
RUN echo "app ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
RUN chmod u+s /usr/bin/sudo
RUN ls -lhd /usr/bin/sudo

RUN groupadd  -g 1000 app
RUN useradd -u 1000 -d /app/src -s /bin/bash -g app -M app
RUN mkdir -p /app/src && chown -R app:app /app

RUN pip install --no-cache-dir pip-tools python-dotenv

USER app
ENV HOME=/app/src
WORKDIR /app/src

RUN install -d -o app -g app /app && install -d -o app -g app /app/src
COPY --chown=app:app requirements.txt /app/src/requirements.txt
RUN python3 -m venv /app/venv && . /app/venv/bin/activate && pip install --no-cache-dir -r /app/src/requirements.txt

USER root
RUN . /app/venv/bin/activate && https -F -I -o /tini github.com/krallin/tini/releases/download/v${_TINI_VERSION}/tini-static-amd64 && chmod 755 /tini
USER app

COPY service /service

RUN sudo chown -R app:app /app/src

ENTRYPOINT [ "/tini", "--", "/service" ]
