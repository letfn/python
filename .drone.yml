---
kind: pipeline
type: docker
name: style

platform:
  os: linux
  arch: amd64

steps:
- name: drone fmt
  image: letfn/drone
  settings:
    task: fmt

- name: drone lint
  image: letfn/drone
  settings:
    task: lint

---
kind: pipeline
type: docker
name: build

platform:
  os: linux
  arch: amd64

steps:
- name: kaniko
  image: letfn/drone-kaniko
  settings:
    args: --destination=registry.defn.sh/letfn/python
    cache: true
    cache_repo: registry.defn.sh/defn/cache
    password:
      from_secret: docker_password
    repo: registry.defn.sh/letfn/python
    tag: latest
    username:
      from_secret: docker_username

depends_on:
- fmt
- lint

---
kind: pipeline
type: docker
name: docs

platform:
  os: linux
  arch: amd64

steps:
- name: local
  image: letfn/drone-hugo

depends_on:
- build

---
kind: secret
name: docker_username

get:
  path: kv/data/drone/common
  name: docker_username

---
kind: secret
name: docker_password

get:
  path: kv/data/drone/common
  name: docker_password

---
kind: secret
name: github_token

get:
  path: kv/data/drone/common
  name: github_token

---
kind: pipeline
type: docker
name: requirements

platform:
  os: linux
  arch: amd64

steps:
- name: everything
  image: letfn/python
  commands:
  - . /app/venv/bin/activate
  - pip-compile /drone/src/requirements.in -o /tmp/requirements.txt
  - diff requirements.txt /tmp/requirements.txt || true
  - if test -w . ; then cp /tmp/requirements.txt requirements.txt; fi

...
