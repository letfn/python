---
kind: pipeline
type: docker
name: requirements

platform:
  os: linux
  arch: amd64

steps:
- name: everything
  image: letfn/python
  commands:
  - if test -w . ; then pip-compile /drone/src/requirements.in -o requirements.in.txt; fi
  - if test -w . ; then pip-compile /drone/src/requirements.in.txt requirements.dev -o requirements.txt; fi

---
kind: pipeline
type: docker
name: build

platform:
  os: linux
  arch: amd64

steps:
- name: everything
  image: letfn/drone-kaniko
  settings:
    args: --destination=letfn/python
    cache: true
    cache_repo: defn/cache
    dockerfile: alt/Dockerfile
    password:
      from_secret: docker_password
    repo: letfn/python
    skip_tls_verify: true
    tag: latest
    username:
      from_secret: docker_username
  environment:
    BENCHMARK_FILE: /drone/src/benchmark/build.json

---
kind: pipeline
type: docker
name: fmt

platform:
  os: linux
  arch: amd64

steps:
- name: everything
  image: letfn/drone
  settings:
    task: fmt

---
kind: pipeline
type: docker
name: lint

platform:
  os: linux
  arch: amd64

steps:
- name: everything
  image: letfn/drone
  settings:
    task: lint

---
kind: pipeline
type: docker
name: docs

platform:
  os: linux
  arch: amd64

steps:
- name: local
  image: letfn/drone-hugo

- name: gh-pages
  image: letfn/drone-hugo
  settings:
    github_pages: true

---
kind: pipeline
type: docker
name: fmt-python

platform:
  os: linux
  arch: amd64

steps:
- name: python
  image: letfn/python
  commands:
  - . /app/venv/bin/activate && isort -rc src
  - . /app/venv/bin/activate && black src

---
kind: pipeline
type: docker
name: lint-python

platform:
  os: linux
  arch: amd64

steps:
- name: everything
  image: letfn/python
  commands:
  - . /app/venv/bin/activate && pyflakes src
  - . /app/venv/bin/activate && mypy src

---
kind: pipeline
type: docker
name: test

platform:
  os: linux
  arch: amd64

steps:
- name: everything
  image: letfn/python
  commands:
  - . /app/venv/bin/activate && pytest -v --cov=main --cov-report=term-missing src
  environment:
    COV_CORE_DATAFILE: /tmp/.coverage

...
